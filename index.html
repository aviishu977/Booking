<!DOCTYPE html>
<html lang="ka" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ადგილობრივი სერვისების აპლიკაცია</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        @font-face {
            font-family: 'MyFont';
            src: url('alk-sanet.ttf');
        }
        * {
            font-family: 'MyFont', sans-serif;
            line-height: 1.5;
        }
        .hidden { display: none; }
        @keyframes slideUp {
            0% { transform: translateY(100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .animate-slideUp {
            animation: slideUp 0.3s ease forwards;
        }
        #loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }
        .loader {
            height: 15px;
            aspect-ratio: 5;
            display: flex;
            justify-content: space-between;
            --_g: no-repeat radial-gradient(farthest-side,#000 95%,#0000);
            background: var(--_g),var(--_g);
            background-size: 20% 100%;
            animation: l42-0 1s infinite;
        }
        .loader:before, .loader:after {
            content: "";
            height: inherit;
            aspect-ratio: 1;
            border-radius: 50%;
            background: #000;
            animation: l42-1 1s infinite;
        }
        .loader:after { --s:-1,-1; }
        @keyframes l42-0 {
            0%, 60%  {background-position: calc(1*100%/3) 0, calc(2*100%/3) 0}
            100% {background-position: calc(0*100%/3) 0, calc(3*100%/3) 0}
        }
        @keyframes l42-1 {
            0%   {transform: scale(var(--s,1)) translate(0,0)}
            33%  {transform: scale(var(--s,1)) translate(0,130%)}
            66%  {transform: scale(var(--s,1)) translate(calc(400%/3),130%)}
            100% {transform: scale(var(--s,1)) translate(calc(400%/3),0)}
        }
        #toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            z-index: 50;
        }
        #toast.show {
            opacity: 1;
        }
    </style>
</head>
<body  class="bg-gray-100 text-gray-900 font-sans min-h-screen flex flex-col">
    <div id="loader-container">
        <div class="loader"></div>
    </div>

    <div id="authContainer" class="flex flex-col items-center justify-center min-h-screen bg-gray-200 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm">
            <h1 class="text-3xl font-bold text-center mb-6">V I B R A</h1>
            <form id="authForm" class="space-y-4">
                <div>
                    <label for="authEmail" class="block text-sm font-medium text-gray-700 mb-1">ელ. ფოსტა</label>
                    <input type="email" id="authEmail" required class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-gray-400 focus:outline-none" />
                </div>
                <div>
                    <label for="authPassword" class="block text-sm font-medium text-gray-700 mb-1">პაროლი</label>
                    <input type="password" id="authPassword" required class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-gray-400 focus:outline-none" />
                </div>
                <button type="submit" id="authSubmitBtn" class="w-full bg-gray-900 text-white font-semibold py-3 rounded-xl hover:bg-gray-700 transition">შესვლა</button>
            </form>
            <p id="authMessage" class="mt-4 text-center text-red-500 font-semibold hidden"></p>
            <button id="toggleAuthMode" class="w-full mt-4 text-center text-sm text-gray-600 hover:underline">არ გაქვთ ანგარიში? დარეგისტრირდით</button>
        </div>
    </div>

    <div id="mainApp" class="hidden flex-1 flex flex-col">
        <header style=" width: 100%; display: flex; justify-content: center;">
            <div style="backdrop-filter: blur(3px);
  -webkit-backdrop-filter: blur(3px); width: 90%; border-radius: 1000px;border: 2px solid black;margin-top: 10px; position: fixed;" class="sticky top-0 z-30 flex justify-between items-center px-4 py-2">
            <h1 style="display: flex; align-items: center; gap: 10px;" class="text-2xl font-bold select-none text-gray-800">
                <div style="width: 40px; height: 40px; background-image: url('https://i.postimg.cc/y6SYc4xr/Picsart-25-09-03-18-22-36-781.jpg'); background-size: cover; background-position: center; border-radius: 10px;"></div><vibespot>vibra</vibespot>
            </h1>
            <button id="logoutBtn" class="absolute right-4 text-sm text-gray-600 hover:underline">გასვლა</button>
            </div>
        </header>
        <main style="margin-top:80px;" id="mainContent" class="flex-1 overflow-y-auto bg-gray-100 p-4">
            <section id="exploreView">
                
                <div id="searchContainer" class="mb-4">
                    <input id="searchInput" type="search" placeholder="მოიძიე სასურველი ადგილი..." aria-label="მოძებნე ადგილები" class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-gray-400 transition" />
                    <div id="filterChips" class="flex flex-wrap gap-2 mt-3">
                        <button data-filter="All" class="filter-chip inline-flex items-center px-4 py-2 rounded-full border border-gray-300 text-sm text-gray-700 bg-white hover:bg-gray-100 transition font-semibold">ყველა</button>
                        <button data-filter="Fast Food" class="filter-chip inline-flex items-center px-4 py-2 rounded-full border border-gray-300 text-sm text-gray-700 bg-white hover:bg-gray-100 transition">სწრაფი კვება</button>
                        <button data-filter="Restaurant" class="filter-chip inline-flex items-center px-4 py-2 rounded-full border border-gray-300 text-sm text-gray-700 bg-white hover:bg-gray-100 transition">რესტორანი</button>
                        <button data-filter="Hotel" class="filter-chip inline-flex items-center px-4 py-2 rounded-full border border-gray-300 text-sm text-gray-700 bg-white hover:bg-gray-100 transition">სასტუმრო</button>
                        <button data-filter="Canteen" class="filter-chip inline-flex items-center px-4 py-2 rounded-full border border-gray-300 text-sm text-gray-700 bg-white hover:bg-gray-100 transition">კაფეტერია</button>
                        <button data-filter="Coffee Shop" class="filter-chip inline-flex items-center px-4 py-2 rounded-full border border-gray-300 text-sm text-gray-700 bg-white hover:bg-gray-100 transition">ყავის მაღაზია</button>
                    </div>
                </div>
                <div id="exploreCards" class="space-y-4"></div>
            </section>
            
            <section id="contactView" class="hidden p-4">
                <div class="bg-white rounded-2xl shadow-md p-6 max-w-md mx-auto">
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-900">დაგვიკავშირდით</h2>
                    <div class="space-y-6">
                        <div class="text-center">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">საკონტაქტო ინფორმაცია</h3>
                            <a href="tel:+995598893999" class="flex items-center justify-center gap-4 py-3 px-4 rounded-xl text-gray-800 bg-gray-100 hover:bg-gray-200 transition">
                                <i class="fas fa-phone-alt text-xl text-gray-600"></i>
                                <span class="font-medium">+995 598 893 999</span>
                            </a>
                        </div>
                        <div class="text-center">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">მოგვძებნეთ სოციალურ ქსელებში</h3>
                            <div class=" items-center justify-center gap-4">
                                                 <div class="flex items-center justify-center w-full py-3 px-4 rounded-xl text-white bg-gray-900 hover:bg-gray-700 transition">
                                       <i class="fab fa-instagram text-xl"></i>
                                    <span class="font-medium ml-2">@gio.nadashvili</span>
                                                 </div>   <br>   <div class="flex items-center justify-center w-full py-3 px-4 rounded-xl text-white bg-gray-900 hover:bg-gray-700 transition">
                            
                        
                               <i class="fab fa-tiktok text-xl"></i>
                                    <span class="font-medium ml-2 ">@giorgi_l.l.l</span>
                        </div>            
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="bookingsView" class="hidden space-y-4"></section>
            <section id="profileView" class="hidden p-4">
                <form id="profileForm" class="bg-white p-6 rounded-2xl shadow-md space-y-5">
                    <div>
                        <label for="profileName" class="block text-sm font-semibold mb-2 text-gray-700">სახელი</label>
                        <input type="text" id="profileName" name="profileName" placeholder="თქვენი სრული სახელი" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-gray-400 focus:outline-none transition" />
                    </div>
                    <div>
                        <label for="profilePhone" class="block text-sm font-semibold mb-2 text-gray-700">ტელეფონის ნომერი</label>
                        <input type="tel" id="profilePhone" name="profilePhone" placeholder="+995123456789" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-gray-400 focus:outline-none transition" />
                    </div>
                    <button type="submit" id="saveProfileBtn" class="w-full py-4 rounded-xl font-semibold bg-gray-900 text-white hover:bg-gray-700 transition active:scale-95">პროფილის შენახვა</button>
                </form>
            </section>
        </main>
        <nav class="sticky bottom-0 z-30 flex justify-around items-center border-t border-gray-200 bg-white shadow-lg">
            <button data-tab="explore" aria-label="ძიება" class="nav-tab flex flex-col items-center justify-center py-3 w-full text-gray-700 hover:text-gray-900 ">
                <i class="fas fa-list text-xl mb-1"></i>
                <span class="text-xs font-semibold">ძიება</span>
            </button>
            <button data-tab="bookings" aria-label="ჯავშნები" class="nav-tab flex flex-col items-center justify-center py-3 w-full text-gray-700 hover:text-gray-900 ">
                <i class="fas fa-calendar-check text-xl mb-1"></i>
                <span class="text-xs font-semibold">ჯავშნები</span>
            </button>
            <button data-tab="profile" aria-label="პროფილი" class="nav-tab flex flex-col items-center justify-center py-3 w-full text-gray-700 hover:text-gray-900 ">
                <i class="fas fa-user-cog text-xl mb-1"></i>
                <span class="text-xs font-semibold">პროფილი</span>
            </button>
            <button data-tab="contact" aria-label="კონტაქტი" class="nav-tab flex flex-col items-center justify-center py-3 w-full text-gray-700 hover:text-gray-900">
                <i class="fas fa-envelope text-xl mb-1"></i>
                <span class="text-xs font-semibold">კონტაქტი</span>
            </button>
        </nav>
    </div>

    <div style="border-top: 5px solid black; border-radius: 0;" id="placeDetailModal" class="fixed  inset-x-0 bg-white rounded-t-3xl shadow-2xl p-6 animate-slideUp max-h-[100vh] overflow-y-auto z-40 hidden" role="dialog" aria-modal="true" aria-labelledby="placeDetailTitle">
        <button id="closePlaceDetail" aria-label="დეტალების დახურვა" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-full w-10 h-10 flex items-center justify-center bg-gray-200/50 backdrop-blur-sm">
            <i class="fas fa-times text-xl"></i>
        </button>
        <div  id="placeDetailContent" class="space-y-6">
            <h2 id="placeDetailTitle" class="text-3xl font-bold text-gray-900 mb-1"></h2>
            <p id="placeDetailCategory" class="text-sm text-gray-500 mb-4"></p>
            <div id="placeDetailGallery" class="flex gap-4 overflow-x-auto snap-x snap-mandatory pb-2"></div>
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-800">ამ ადგილის შესახებ</h3>
                <p id="placeDetailDescription" class="text-gray-700 leading-relaxed"></p>
                <div class="space-y-2 text-sm text-gray-600">
                    <p><i class="fas fa-star text-yellow-500 mr-2"></i><span id="placeDetailRating"></span> · <span id="placeDetailPriceTier"></span></p>
                    <p><i class="fas fa-map-marker-alt text-gray-500 mr-2"></i><span id="placeDetailAddress"></span></p>
                    <p><i class="fas fa-clock text-gray-500 mr-2"></i><span id="placeDetailHours"></span></p>
                </div>
            </div>
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-800">კონტაქტი და ჯავშნები</h3>
                <a href="#" id="placeDetailPhone" class="flex items-center gap-4 bg-gray-100 p-4 rounded-xl text-gray-800 hover:bg-gray-200 transition">
                    <i class="fas fa-phone-alt text-xl text-gray-600"></i>
                    <span class="font-medium">დაგვირეკეთ: <span class="underline"></span></span>
                </a>
                <button id="btnOpenBooking" class="w-full py-4 rounded-xl font-semibold bg-gray-900 text-white hover:bg-gray-700 transition active:scale-95">დაჯავშნა</button>
            </div>
        </div>
    </div>

    <div id="bookingModal" class="fixed bottom-0 inset-x-0 bg-white rounded-t-3xl shadow-2xl p-6 animate-slideUp max-h-[90vh] overflow-y-auto z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="bookingModalTitle">
        <button id="closeBookingModal" aria-label="ჯავშნის დახურვა" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-full w-10 h-10 flex items-center justify-center bg-gray-200/50 backdrop-blur-sm">
            <i class="fas fa-times text-xl"></i>
        </button>
        <div class="space-y-6">
            <h3 id="bookingModalTitle" class="text-3xl font-bold mb-4 text-gray-900">მაგიდის დაჯავშნა</h3>
            <form id="bookingForm" class="space-y-5">
                <div>
                    <label for="bookingOption" class="block text-sm font-semibold mb-2 text-gray-700">აირჩიეთ ვარიანტი</label>
                    <select id="bookingOption" name="bookingOption" required class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-gray-400 focus:outline-none transition"></select>
                </div>
                <div>
                    <label for="bookingName" class="block text-sm font-semibold mb-2 text-gray-700">თქვენი სახელი</label>
                    <input type="text" id="bookingName" name="bookingName" required placeholder="სრული სახელი" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-gray-400 focus:outline-none transition" />
                </div>
                <div>
                    <label for="bookingPhone" class="block text-sm font-semibold mb-2 text-gray-700">ტელეფონის ნომერი</label>
                    <input type="tel" id="bookingPhone" name="bookingPhone" required placeholder="+995123456789" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-gray-400 focus:outline-none transition" />
                </div>
                <div>
                    <label for="bookingDate" class="block text-sm font-semibold mb-2 text-gray-700">თარიღი და დრო</label>
                    <input type="datetime-local" id="bookingDate" name="bookingDate" required class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-gray-400 focus:outline-none transition" />
                </div>
                <button type="submit" class="w-full py-4 rounded-xl font-semibold bg-gray-900 text-white hover:bg-gray-700 transition active:scale-95">ჯავშნის დადასტურება</button>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-4 rounded-xl shadow-lg opacity-0 pointer-events-none transition-opacity duration-300 ease-in-out z-50 select-none text-center"></div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
      (() => {
        "use strict";
        const firebaseConfig = {
            apiKey: "AIzaSyDcundXzUzWhfGWtRYz9SPltkXknjfwFyI",
            authDomain: "locser-2c0ba.firebaseapp.com",
            databaseURL: "https://locser-2c0ba-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "locser-2c0ba",
            storageBucket: "locser-2c0ba.firebasestorage.app",
            messagingSenderId: "554975533572",
            appId: "1:554975533572:web:fe90ab36550f5edac63351"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const placesRef = db.ref('places');
        const bookingsRef = db.ref('bookings');
        const usersRef = db.ref('users');
        const analyticsRef = db.ref('analytics');
        const contactRef = db.ref('contactMessages');

        const authContainer = document.getElementById("authContainer");
        const mainApp = document.getElementById("mainApp");
        const authForm = document.getElementById("authForm");
        const authEmailInput = document.getElementById("authEmail");
        const authPasswordInput = document.getElementById("authPassword");
        const authSubmitBtn = document.getElementById("authSubmitBtn");
        const toggleAuthModeBtn = document.getElementById("toggleAuthMode");
        const authMessage = document.getElementById("authMessage");
        const logoutBtn = document.getElementById("logoutBtn");
        const loaderContainer = document.getElementById("loader-container");

        const exploreView = document.getElementById("exploreView");
        const exploreCards = document.getElementById("exploreCards");
        const contactView = document.getElementById("contactView");
        const bookingsView = document.getElementById("bookingsView");
        const profileView = document.getElementById("profileView");
        const navTabs = document.querySelectorAll(".nav-tab");
        const searchInput = document.getElementById("searchInput");
        const filterChips = document.querySelectorAll(".filter-chip");
        const placeDetailModal = document.getElementById("placeDetailModal");
        const closePlaceDetail = document.getElementById("closePlaceDetail");
        const bookingModal = document.getElementById("bookingModal");
        const closeBookingModal = document.getElementById("closeBookingModal");
        const bookingForm = document.getElementById("bookingForm");
        const toast = document.getElementById("toast");
        const btnOpenBooking = document.getElementById("btnOpenBooking");
        const bookingOptionSelect = document.getElementById("bookingOption");
        const bookingNameInput = document.getElementById("bookingName");
        const bookingPhoneInput = document.getElementById("bookingPhone");
        const bookingDateInput = document.getElementById("bookingDate");
        const profileForm = document.getElementById("profileForm");
        const profileNameInput = document.getElementById("profileName");
        const profilePhoneInput = document.getElementById("profilePhone");
        const saveProfileBtn = document.getElementById("saveProfileBtn");
        const contactForm = document.getElementById("contactForm");

        let currentTab = "explore";
        let currentFilter = "All";
        let currentSearch = "";
        let selectedPlace = null;
        let placesData = {};
        let bookingsData = {};
        let userData = {};
        let authMode = "login";
        
        const georgianErrorMap = {
            'auth/invalid-email': 'არასწორი ელ. ფოსტა.',
            'auth/user-disabled': 'თქვენი ანგარიში დაბლოკილია.',
            'auth/user-not-found': 'მომხმარებელი ვერ მოიძებნა.',
            'auth/wrong-password': 'არასწორი პაროლი.',
            'auth/email-already-in-use': 'ასეთი ელ. ფოსტა უკვე არსებობს.',
            'auth/weak-password': 'პაროლი ძალიან სუსტია. მინიმუმ 6 სიმბოლო.',
            'default': 'მოხდა უცნობი შეცდომა.'
        };

        function getGeorgianErrorMessage(errorCode) {
            return georgianErrorMap[errorCode] || georgianErrorMap['default'];
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add("opacity-100");
            toast.classList.remove("opacity-0", "pointer-events-none");
            setTimeout(() => {
                toast.classList.remove("opacity-100");
                toast.classList.add("opacity-0");
            }, 3000);
        }
        
        function showCustomConfirm(message, onConfirm) {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            confirmModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-6 space-y-4 max-w-sm w-full">
                    <p class="text-lg font-semibold text-gray-800">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button id="cancelBtn" class="px-4 py-2 rounded-lg text-gray-700 font-semibold hover:bg-gray-200 transition">გაუქმება</button>
                        <button id="confirmBtn" class="px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition">დადასტურება</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            confirmBtn.addEventListener('click', () => {
                onConfirm(true);
                confirmModal.remove();
            });

            cancelBtn.addEventListener('click', () => {
                onConfirm(false);
                confirmModal.remove();
            });
        }

        function formatDateTimeLocal(dateStr) {
            if (!dateStr) return "";
            const d = new Date(dateStr);
            return d.toLocaleString('ka-GE', { dateStyle: "medium", timeStyle: "short" });
        }

        function filterPlaces() {
            const allPlaces = Object.values(placesData);
            return allPlaces.filter(place => {
                const matchesFilter = currentFilter === "All" || place.category === currentFilter;
                const searchLower = currentSearch.toLowerCase();
                const matchesSearch =
                    place.name.toLowerCase().includes(searchLower) ||
                    place.category.toLowerCase().includes(searchLower) ||
                    place.short.toLowerCase().includes(searchLower) ||
                    place.description.toLowerCase().includes(searchLower) ||
                    place.address.toLowerCase().includes(searchLower);
                return matchesFilter && matchesSearch;
            });
        }

        function renderExplore() {
            exploreCards.innerHTML = "";
            const filtered = filterPlaces();
            if (filtered.length === 0) {
                exploreCards.innerHTML = '<p class="text-center text-gray-500 mt-10">ადგილები ვერ მოიძებნა.</p>';
                return;
            }
            filtered.forEach(place => {
                const card = document.createElement("article");
                card.setAttribute("tabindex", "0");
                card.className = "flex flex-col gap-3 bg-white shadow-md rounded-2xl p-4 cursor-pointer transform transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 active:scale-95";
                card.setAttribute("role", "button");
                card.setAttribute("aria-label", `იხილეთ დეტალები: ${place.name}`);

                const img = document.createElement("img");
                img.src = place.photos[0];
                img.alt = `${place.name}-ის ფოტო`;
                img.className = "w-full h-48 object-cover rounded-xl shadow-sm";
                card.appendChild(img);

                const content = document.createElement("div");
                content.className = "flex flex-col gap-1";

                const nameCat = document.createElement("div");
                nameCat.className = "flex justify-between items-start";
                const nameEl = document.createElement("h3");
                nameEl.className = "text-xl font-semibold text-gray-900 truncate pr-2";
                nameEl.textContent = place.name;
                const catEl = document.createElement("span");
                catEl.className = "px-2 py-1 bg-gray-200 text-gray-600 text-xs font-medium rounded-full whitespace-nowrap";
                const categoryMapping = {
                    "Fast Food": "სწრაფი კვება",
                    "Restaurant": "რესტორანი",
                    "Hotel": "სასტუმრო",
                    "Canteen": "კაფეტერია",
                    "Coffee Shop": "ყავის მაღაზია",
                    "All": "ყველა"
                };
                catEl.textContent = categoryMapping[place.category] || place.category;
                nameCat.appendChild(nameEl);
                nameCat.appendChild(catEl);
                content.appendChild(nameCat);

                const ratingAddr = document.createElement("div");
                ratingAddr.className = "flex items-center gap-1 text-sm text-gray-500";
                const ratingEl = document.createElement("div");
                ratingEl.className = "flex items-center gap-1 text-yellow-500 font-semibold";
                ratingEl.innerHTML = `<i class="fas fa-star text-base"></i><span>${place.rating.toFixed(1)}</span>`;
                const addrEl = document.createElement("p");
                addrEl.className = "truncate text-gray-600 pl-1";
                addrEl.textContent = `· ${place.address}`;
                ratingAddr.appendChild(ratingEl);
                ratingAddr.appendChild(addrEl);
                content.appendChild(ratingAddr);

                const shortDesc = document.createElement("p");
                shortDesc.className = "text-sm text-gray-600 mt-1";
                shortDesc.textContent = place.short;
                content.appendChild(shortDesc);

                card.appendChild(content);

                card.addEventListener("click", () => openPlaceDetail(place.id));
                card.addEventListener("keydown", e => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        openPlaceDetail(place.id);
                    }
                });

                exploreCards.appendChild(card);
            });
        }

        function renderBookings() {
            bookingsView.innerHTML = "";
            const userBookings = Object.values(bookingsData).filter(b => b.userId === auth.currentUser.uid);
            const sortedBookings = userBookings.sort((a, b) => new Date(b.date) - new Date(a.date));
            if (sortedBookings.length === 0) {
                bookingsView.innerHTML = '<p class="text-center text-gray-500 mt-10">თქვენ არ გაქვთ აქტიური ჯავშნები.</p>';
                return;
            }
            sortedBookings.forEach((booking, index) => {
                const place = placesData[booking.placeId];
                if (!place) return;
                const bookingOption = place.bookingOptions.find(o => o.id === booking.bookingOptionId);
                const card = document.createElement("article");
                card.className = "bg-white rounded-2xl shadow-md p-4 mb-4 flex flex-col gap-2";

                const header = document.createElement("div");
                header.className = "flex justify-between items-start";
                const nameEl = document.createElement("h3");
                nameEl.className = "text-lg font-bold text-gray-900 truncate";
                nameEl.textContent = place.name;
                const statusBadge = document.createElement("span");
                let statusText = '';
                let statusClass = '';
                
                if (booking.status === 'pending') {
                    statusText = 'მოლოდინში';
                    statusClass = 'bg-yellow-100 text-yellow-600';
                } else if (booking.status === 'confirmed') {
                    statusText = 'დადასტურებული';
                    statusClass = 'bg-green-100 text-green-600';
                } else if (booking.status === 'cancelled') {
                    statusText = 'გაუქმებული';
                    statusClass = 'bg-red-100 text-red-600';
                }

                statusBadge.className = `px-3 py-1 rounded-full text-xs font-semibold select-none ${statusClass}`;
                statusBadge.textContent = statusText;
                
                header.appendChild(nameEl);
                header.appendChild(statusBadge);
                card.appendChild(header);

                const details = document.createElement("div");
                details.className = "text-sm text-gray-600 space-y-2 mt-2";
                details.innerHTML = `
                  <div class="flex items-center gap-2"><i class="fas fa-bookmark text-gray-400"></i><p><strong>ვარიანტი:</strong> ${bookingOption ? bookingOption.title : "არ არის"}</p></div>
                  <div class="flex items-center gap-2"><i class="fas fa-calendar-alt text-gray-400"></i><p><strong>თარიღი:</strong> ${formatDateTimeLocal(booking.date)}</p></div>
                `;
                card.appendChild(details);
                
                if (booking.status === 'pending') {
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'ჯავშნის გაუქმება';
                    cancelButton.className = "mt-3 w-full py-2 rounded-xl font-semibold bg-red-600 text-white hover:bg-red-700 transition active:scale-95";
                    cancelButton.dataset.bookingId = Object.keys(bookingsData).find(key => bookingsData[key] === booking);
                    cancelButton.addEventListener('click', async () => {
                        showCustomConfirm('დარწმუნებული ხართ, რომ გსურთ ჯავშნის გაუქმება?', async (confirmed) => {
                            if (confirmed) {
                                await bookingsRef.child(cancelButton.dataset.bookingId).child('status').set('cancelled');
                                showToast('ჯავშანი წარმატებით გაუქმდა');
                            }
                        });
                    });
                    card.appendChild(cancelButton);
                }

                bookingsView.appendChild(card);
            });
        }

        function renderProfile() {
            profileNameInput.value = userData.name || "";
            profilePhoneInput.value = userData.phone || "";
        }

        function renderPlaceDetail(place) {
            if (!place) return;
            placeDetailModal.querySelector("#placeDetailTitle").textContent = place.name;
            const categoryMapping = {
                "Fast Food": "სწრაფი კვება",
                "Restaurant": "რესტორანი",
                "Hotel": "სასტუმრო",
                "Canteen": "კაფეტერია",
                "Coffee Shop": "ყავის მაღაზია"
            };
            placeDetailModal.querySelector("#placeDetailCategory").textContent = categoryMapping[place.category] || place.category;
            placeDetailModal.querySelector("#placeDetailDescription").textContent = place.description;
            placeDetailModal.querySelector("#placeDetailRating").textContent = place.rating.toFixed(1);
            placeDetailModal.querySelector("#placeDetailPriceTier").textContent = place.priceTier;
            placeDetailModal.querySelector("#placeDetailAddress").textContent = place.address;
            placeDetailModal.querySelector("#placeDetailHours").textContent = place.openingHours;
            const phoneLink = placeDetailModal.querySelector("#placeDetailPhone");
            phoneLink.querySelector("span").textContent = `დაგვირეკეთ: ${place.phone}`;
            phoneLink.href = `tel:${place.phone.replace(/\s+/g, "")}`;

            const gallery = placeDetailModal.querySelector("#placeDetailGallery");
            gallery.innerHTML = "";
            place.photos.forEach((photo, i) => {
                const img = document.createElement("img");
                img.src = photo;
                img.alt = `${place.name}-ის ფოტო ${i + 1}`;
                img.className = "w-64 h-48 object-cover rounded-xl shadow-sm flex-shrink-0 snap-center";
                gallery.appendChild(img);
            });
        }

        function openPlaceDetail(placeId) {
            selectedPlace = placesData[placeId];
            if (!selectedPlace) return;
            renderPlaceDetail(selectedPlace);
            placeDetailModal.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");
        }

        function closePlaceDetailModal() {
            placeDetailModal.classList.add("hidden");
            document.body.classList.remove("overflow-hidden");
            selectedPlace = null;
        }

        function openBookingModal() {
            if (!selectedPlace) return;
            bookingOptionSelect.innerHTML = "";
            selectedPlace.bookingOptions.forEach(opt => {
                const option = document.createElement("option");
                option.value = opt.id;
                option.textContent = `${opt.title} - ${opt.price}₾`;
                bookingOptionSelect.appendChild(option);
            });
            bookingNameInput.value = userData.name || "";
            bookingPhoneInput.value = userData.phone || "";
            bookingDateInput.value = "";
            
            const now = new Date();
            const minDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            bookingDateInput.min = minDateTime;

            bookingModal.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");
        }

        function closeBookingModalFunc() {
            bookingModal.classList.add("hidden");
            document.body.classList.remove("overflow-hidden");
        }

        function switchTab(tab) {
            currentTab = tab;
            exploreView.classList.add("hidden");
            contactView.classList.add("hidden");
            bookingsView.classList.add("hidden");
            profileView.classList.add("hidden");

            navTabs.forEach(t => {
                t.classList.remove("text-gray-900", "font-semibold");
                t.classList.add("text-gray-700");
            });

            switch (tab) {
                case "explore":
                    exploreView.classList.remove("hidden");
                    navTabs[0].classList.add("text-gray-900", "font-semibold");
                    renderExplore();
                    break;
                case "bookings":
                    bookingsView.classList.remove("hidden");
                    navTabs[1].classList.add("text-gray-900", "font-semibold");
                    renderBookings();
                    break;
                case "profile":
                    profileView.classList.remove("hidden");
                    navTabs[2].classList.add("text-gray-900", "font-semibold");
                    renderProfile();
                    break;
                 case "contact":
                    contactView.classList.remove("hidden");
                    navTabs[3].classList.add("text-gray-900", "font-semibold");
                    break;
            }
        }

        navTabs.forEach(tabBtn => {
            tabBtn.addEventListener("click", () => {
                switchTab(tabBtn.dataset.tab);
                closePlaceDetailModal();
                closeBookingModalFunc();
            });
        });

        searchInput.addEventListener("input", () => {
            currentSearch = searchInput.value.trim();
            renderExplore();
        });

        filterChips.forEach(chip => {
            chip.addEventListener("click", () => {
                filterChips.forEach(c => c.classList.remove("font-semibold", "bg-gray-100"));
                chip.classList.add("font-semibold", "bg-gray-100");
                currentFilter = chip.dataset.filter;
                renderExplore();
            });
        });

        closePlaceDetail.addEventListener("click", closePlaceDetailModal);
        closeBookingModal.addEventListener("click", closeBookingModalFunc);
        btnOpenBooking.addEventListener("click", openBookingModal);

        bookingForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!selectedPlace || !auth.currentUser) return;

            const optionId = bookingOptionSelect.value;
            const name = bookingNameInput.value.trim();
            const phone = bookingPhoneInput.value.trim();
            const date = bookingDateInput.value;

            if (!optionId || !name || !phone || !date) {
                showToast("გთხოვთ შეავსოთ ყველა ველი");
                return;
            }
            
            await usersRef.child(auth.currentUser.uid).update({ name, phone });

            const option = selectedPlace.bookingOptions.find(o => o.id === optionId);
            const newBooking = {
                placeId: selectedPlace.id,
                userId: auth.currentUser.uid,
                bookingOptionId: optionId,
                bookingOptionTitle: option ? option.title : "ვარიანტი არ მოიძებნა",
                name,
                phone,
                date,
                status: "pending",
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            await bookingsRef.push(newBooking);
            
            const place = selectedPlace;
            
            closeBookingModalFunc();
            closePlaceDetailModal();

            const customToast = document.createElement('div');
            customToast.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 bg-white text-gray-900 p-6 rounded-2xl shadow-lg opacity-0 pointer-events-none transition-all duration-300 ease-in-out z-50 text-center flex flex-col items-center gap-4 w-[90%] max-w-sm';
            customToast.innerHTML = `
                <i class="fas fa-check-circle text-green-500 text-3xl"></i>
                <p class="text-xl font-semibold">ჯავშანი გაგზავნილია!</p>
                <p class="text-sm text-gray-600">თქვენი ჯავშნის მოთხოვნა გაეგზავნა მომსახურების მიმწოდებელს. დამატებითი ინფორმაციისთვის შეგიძლიათ დაუკავშირდეთ მათ.</p>
                <div class="flex gap-4 w-full">
                    <a href="tel:${place.phone.replace(/\s+/g, "")}" class="flex-1 py-3 rounded-xl font-semibold bg-gray-200 text-gray-900 hover:bg-gray-300 transition active:scale-95"><i class="fas fa-phone-alt mr-2"></i>დარეკვა</a>
                </div>
            `;

            document.body.appendChild(customToast);
            setTimeout(() => {
                customToast.classList.remove('opacity-0', 'pointer-events-none');
                customToast.classList.add('opacity-100');
            }, 10);
            
            setTimeout(() => {
                customToast.classList.add('opacity-0');
                setTimeout(() => {
                    customToast.remove();
                }, 300);
            }, 10000);
        });

        profileForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = profileNameInput.value.trim();
            const phone = profilePhoneInput.value.trim();
            if (!name || !phone) {
                showToast("გთხოვთ შეავსოთ ყველა ველი");
                return;
            }
            try {
                await usersRef.child(auth.currentUser.uid).update({ name, phone });
                userData = { name, phone };
                saveProfileBtn.textContent = "შენახულია!";
                saveProfileBtn.classList.remove('bg-gray-900');
                saveProfileBtn.classList.add('bg-green-600');
                setTimeout(() => {
                    saveProfileBtn.textContent = "პროფილის შენახვა";
                    saveProfileBtn.classList.remove('bg-green-600');
                    saveProfileBtn.classList.add('bg-gray-900');
                }, 2000);
            } catch (error) {
                console.error("Failed to save profile:", error);
                showToast("პროფილის შენახვა ვერ მოხერხდა.");
            }
        });

        authForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authMessage.classList.add("hidden");

            try {
                if (authMode === "login") {
                    await auth.signInWithEmailAndPassword(email, password);
                } else {
                    await auth.createUserWithEmailAndPassword(email, password);
                }
            } catch (error) {
                authMessage.textContent = getGeorgianErrorMessage(error.code);
                authMessage.classList.remove("hidden");
            }
        });

        toggleAuthModeBtn.addEventListener("click", () => {
            authMode = authMode === "login" ? "signup" : "login";
            authSubmitBtn.textContent = authMode === "login" ? "შესვლა" : "რეგისტრაცია";
            toggleAuthModeBtn.textContent = authMode === "login" ? "არ გაქვთ ანგარიში? დარეგისტრირდით" : "უკვე გაქვთ ანგარიში? შედით";
        });

        logoutBtn.addEventListener("click", () => {
            auth.signOut();
        });

        auth.onAuthStateChanged(user => {
            if (user) {
                authContainer.classList.add("hidden");
                mainApp.classList.remove("hidden");
                loaderContainer.style.opacity = '0';
                setTimeout(() => loaderContainer.style.visibility = 'hidden', 500);

                usersRef.child(user.uid).once('value', snapshot => {
                    userData = snapshot.val() || {};
                    if (currentTab === 'profile') {
                        renderProfile();
                    }
                });

                const connectedRef = db.ref(".info/connected");
                const presenceRef = db.ref('analytics/presence');
                const userRef = presenceRef.child(user.uid);
                userRef.onDisconnect().remove();
                userRef.set(true);

            } else {
                authContainer.classList.remove("hidden");
                mainApp.classList.add("hidden");
                userData = {};
                loaderContainer.style.opacity = '0';
                setTimeout(() => loaderContainer.style.visibility = 'hidden', 500);
            }
        });

        document.addEventListener("keydown", e => {
            if (e.key === "Escape") {
                if (!placeDetailModal.classList.contains("hidden")) {
                    closePlaceDetailModal();
                }
                if (!bookingModal.classList.contains("hidden")) {
                    closeBookingModalFunc();
                }
            }
        });

        placesRef.on('value', snapshot => {
            placesData = snapshot.val() || {};
            if (currentTab === 'explore') {
                renderExplore();
            }
            if (currentTab === 'bookings' && auth.currentUser) {
                renderBookings();
            }
            if (loaderContainer.style.visibility !== 'hidden' && auth.currentUser) {
                 loaderContainer.style.opacity = '0';
                 setTimeout(() => loaderContainer.style.visibility = 'hidden', 500);
            }
        });

        bookingsRef.on('value', snapshot => {
            bookingsData = snapshot.val() || {};
            if (currentTab === 'bookings' && auth.currentUser) {
                renderBookings();
            }
        });

        analyticsRef.child('presence').on('value', snapshot => {
            const liveUsers = snapshot.numChildren();
            analyticsRef.child('activeUsers').set(liveUsers);
        });

        filterChips.forEach(c => {
            if (c.dataset.filter === "All") {
                c.classList.add("font-semibold", "bg-gray-100");
            }
        });

        switchTab("explore");
      })();
    </script>
</body>
</html>
